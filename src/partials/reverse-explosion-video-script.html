<script>
(function() {
    var container = document.querySelector('[data-reverse-explosion]');
    if (!container) return;

    var items = Array.from(container.querySelectorAll('[data-reverse-explosion-item]'));
    var replay = document.querySelector('[data-reverse-explosion-replay]');
    if (items.length === 0) return;

    function getStrength(el) {
        var v = Number(el.dataset.reverseExplosionStrength);
        return (v > 0) ? v : 1;
    }

    function prepare() {
        items.forEach(function(item, i) {
            var s = getStrength(item);
            var angle = Math.random() * Math.PI * 2;
            var spread = 260 + Math.random() * 120;
            var distance = spread * (0.6 + Math.random() * 0.5);
            var x = Math.cos(angle) * distance * s;
            var y = Math.sin(angle) * distance * s;
            var z = (120 + Math.random() * 320) * s;
            var rotation = (Math.random() * 2 - 1) * 16 * s;
            var scale = 0.78 + Math.random() * 0.45;
            var blur = 3 + Math.random() * 8;
            var delay = i * 140 + Math.random() * 180;

            item.style.setProperty('--rx-x', x.toFixed(1) + 'px');
            item.style.setProperty('--rx-y', y.toFixed(1) + 'px');
            item.style.setProperty('--rx-z', z.toFixed(1) + 'px');
            item.style.setProperty('--rx-rot', rotation.toFixed(1) + 'deg');
            item.style.setProperty('--rx-scale', scale.toFixed(2));
            item.style.setProperty('--rx-blur', blur.toFixed(1) + 'px');
            item.style.setProperty('--rx-delay', delay.toFixed(0) + 'ms');
            item.style.setProperty('--rx-duration', '2800ms');
        });
    }

    function showReplay() {
        if (replay) replay.classList.add('is-visible');
    }

    function hideReplay() {
        if (replay) replay.classList.remove('is-visible');
    }

    // After the shimmer CSS animation finishes, swap to plain white text
    // so Firefox doesn't blank out the background-clip:text element.
    var heroTitle = container.querySelector('.hero-title');
    if (heroTitle) {
        heroTitle.addEventListener('animationend', function() {
            heroTitle.classList.add('shimmer-done');
        });
    }

    function play() {
        hideReplay();

        // Reset shimmer state for replay.
        if (heroTitle) heroTitle.classList.remove('shimmer-done');

        // 1. Remove active state and disable transitions so the browser
        //    commits the scattered positions without animating to them.
        container.classList.remove('is-active');
        items.forEach(function(item) { item.style.transition = 'none'; });

        // 2. Set randomised scattered positions.
        prepare();

        // 3. Force the browser to compute the scattered layout (sync reflow).
        container.offsetHeight;

        // 4. Re-enable CSS transitions.
        items.forEach(function(item) { item.style.transition = ''; });

        // 5. Another forced reflow so the browser registers the transition
        //    re-enablement as a separate style change from the class toggle.
        container.offsetHeight;

        // 6. Trigger the animation.
        container.classList.add('is-active');

        // Show replay button after animation completes (~4s covers duration + stagger).
        setTimeout(showReplay, 4000);
    }

    // Initial delay (600ms) gives a clean gradient frame at the start of the recording.
    setTimeout(play, 600);

    if (replay) replay.addEventListener('click', play);
})();
</script>
